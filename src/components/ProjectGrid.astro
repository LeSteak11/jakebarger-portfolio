---
export interface Props {
  projects: Array<{
    id: string;
    title: string;
    description: string;
    tags: string[];
    images: Array<{
      src: string;
      alt: string;
      caption?: string;
    }>;
    year: number;
    sports?: string[];
    featured: boolean;
  }>;
  title?: string;
  showFilters?: boolean;
}

const { projects, title, showFilters = false } = Astro.props;

// Get unique tags and sports for filtering (handle optional sports)
const allTags = [...new Set(projects.flatMap(p => p.tags || []))];
const allSports = [...new Set(projects.flatMap(p => p.sports || []))].filter(Boolean);
---

<div class="project-grid-container">
  {title && (
    <div class="mb-8">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">{title}</h2>
    </div>
  )}

  {showFilters && (
    <div class="mb-8 p-4 bg-gray-50 rounded-lg">
      <div class="flex flex-wrap gap-4">
        <!-- Tag Filters -->
        <div class="flex-1 min-w-64">
          <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category</label>
          <select class="tag-filter w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Categories</option>
            {allTags.map(tag => (
              <option value={tag}>{tag.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>
            ))}
          </select>
        </div>

        <!-- Sport Filters -->
        {allSports.length > 0 && (
          <div class="flex-1 min-w-64">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Sport</label>
            <select class="sport-filter w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="">All Sports</option>
              {allSports.map(sport => (
                <option value={sport}>{sport.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>
              ))}
            </select>
          </div>
        )}

        <!-- Year Filter -->
        <div class="flex-1 min-w-32">
          <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
          <select class="year-filter w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Years</option>
            {[...new Set(projects.map(p => p.year))].sort((a, b) => b - a).map(year => (
              <option value={year}>{year}</option>
            ))}
          </select>
        </div>

        <!-- Featured Filter -->
        <div class="flex-1 min-w-32">
          <label class="block text-sm font-medium text-gray-700 mb-2">Featured</label>
          <select class="featured-filter w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Projects</option>
            <option value="true">Featured Only</option>
            <option value="false">Non-Featured</option>
          </select>
        </div>
      </div>
    </div>
  )}

  <!-- Projects Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="projects-grid">
    {projects.map((project) => (
      <div 
        class="project-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300"
        data-tags={(project.tags || []).join(',')}
        data-sports={(project.sports || []).join(',')}
        data-year={project.year}
        data-featured={project.featured}
      >
        <!-- Featured Badge -->
        {project.featured && (
          <div class="absolute top-4 left-4 z-10">
            <span class="bg-primary-600 text-white px-2 py-1 text-xs font-semibold rounded-full">
              Featured
            </span>
          </div>
        )}

        <!-- Project Image -->
        <div class="relative h-48 bg-gray-200">
          {project.images[0] ? (
            <img 
              src={project.images[0].src} 
              alt={project.images[0].alt}
              class="w-full h-full object-cover"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
            />
          ) : null}
          <!-- Placeholder for missing images -->
          <div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400" style="display: none;">
            <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>

        <!-- Project Content -->
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-900 mb-2">{project.title}</h3>
          <p class="text-gray-600 text-sm mb-4 line-clamp-3">{project.description}</p>
          
          <!-- Tags -->
          <div class="flex flex-wrap gap-2 mb-4">
            {(project.tags || []).slice(0, 3).map(tag => (
              <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">
                {tag.replace('-', ' ')}
              </span>
            ))}
            {(project.tags || []).length > 3 && (
              <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                +{(project.tags || []).length - 3} more
              </span>
            )}
          </div>

          <!-- Meta Info -->
          <div class="flex justify-between items-center text-sm text-gray-500">
            <span>{project.year}</span>
            <span>{(project.images || []).length} image{(project.images || []).length !== 1 ? 's' : ''}</span>
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- No Results Message -->
  <div id="no-results" class="hidden text-center py-12">
    <div class="text-gray-500">
      <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.076-2.319C7.76 12.68 9.818 12 12 12s4.24.68 6.076 1.681z" />
      </svg>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No projects found</h3>
      <p class="text-gray-500">Try adjusting your filters to see more results.</p>
    </div>
  </div>
</div>

{showFilters && (
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tagFilter = document.querySelector('.tag-filter');
      const sportFilter = document.querySelector('.sport-filter');
      const yearFilter = document.querySelector('.year-filter');
      const featuredFilter = document.querySelector('.featured-filter');
      const projectCards = document.querySelectorAll('.project-card');
      const noResults = document.getElementById('no-results');

      function filterProjects() {
        const selectedTag = tagFilter?.value || '';
        const selectedSport = sportFilter?.value || '';
        const selectedYear = yearFilter?.value || '';
        const selectedFeatured = featuredFilter?.value || '';

        let visibleCount = 0;

        projectCards.forEach(card => {
          const cardTags = card.getAttribute('data-tags')?.split(',') || [];
          const cardSports = card.getAttribute('data-sports')?.split(',') || [];
          const cardYear = card.getAttribute('data-year') || '';
          const cardFeatured = card.getAttribute('data-featured') || '';

          const matchesTag = !selectedTag || cardTags.includes(selectedTag);
          const matchesSport = !selectedSport || cardSports.includes(selectedSport);
          const matchesYear = !selectedYear || cardYear === selectedYear;
          const matchesFeatured = !selectedFeatured || cardFeatured === selectedFeatured;

          if (matchesTag && matchesSport && matchesYear && matchesFeatured) {
            card.style.display = 'block';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        if (noResults) {
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
      }

      // Add event listeners
      [tagFilter, sportFilter, yearFilter, featuredFilter].forEach(filter => {
        filter?.addEventListener('change', filterProjects);
      });
    });
  </script>
)}

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>